generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  CONTRIBUTOR
  VIEWER
}

enum PricingWorkspace {
  BOQ
  PACK
}

enum PricingTemplateScope {
  GLOBAL
  OPPORTUNITY
}

enum UserStatus {
  ACTIVE
  DISABLED
  INVITED
  PENDING
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      Role     @default(VIEWER)
  team      String?
  passwordHash String?
  isActive  Boolean  @default(true)
  status    UserStatus @default(ACTIVE)
  mustChangePassword Boolean @default(false)
  lastLoginAt DateTime?
  passwordChangedAt DateTime?
  userType  String   @default("INTERNAL")
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  opportunities Opportunity[] @relation("OwnerOpps")
  bidOwnerLinks OpportunityBidOwner[]
  businessRoleLinks UserBusinessRole[]
  notificationPreferences NotificationPreference[]
  notifications Notification[]
  inviteTokens InviteToken[]
  resetTokens PasswordResetToken[]
}

model InviteToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([expiresAt])
}

model Client {
  id        String   @id @default(uuid())
  name      String
  tenantId  String   @default("default")
  sector    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  opportunities Opportunity[]

  @@index([name])
  @@unique([name, tenantId])
}

model Opportunity {
  id             String   @id @default(uuid())
  clientId       String
  ownerId        String?
  boqTemplateId  String?
  packTemplateId String?
  tenderRef      String?
  title          String
  description    String?
  sourcePortal   String?
  sourceTenderId String?
  discoveryDate  DateTime?
  submissionDate DateTime?
  startDate      DateTime?
  status         String?
  stage          String?
  priorityRank   Int?
  daysLeft       Int?
  modeOfSubmission String?
  bondRequired   Boolean? @default(false)
  bondAmount     Float?
  validityDays   Int?
  dataOwner      String?
  tenantId       String   @default("default")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  goNoGoStatus   ApprovalStatus @default(PENDING)
  goNoGoUpdatedAt DateTime?
  bondReminderSentAt DateTime?
  reviewFreezeReminderSentAt DateTime?
  portalRehearsalReminderSentAt DateTime?
  slaLastNotifiedLevel String?
  slaLastNotifiedAt DateTime?

  client Client @relation(fields: [clientId], references: [id])
  owner  User?  @relation("OwnerOpps", fields: [ownerId], references: [id], onDelete: SetNull)
  bidOwners OpportunityBidOwner[]
  boqTemplate  PricingTemplate? @relation("BoqTemplate", fields: [boqTemplateId], references: [id])
  packTemplate PricingTemplate? @relation("PackTemplate", fields: [packTemplateId], references: [id])
  pricingTemplates PricingTemplate[] @relation("TemplateOwner")
  boqItems        BoQItem[]
  vendorQuotes    VendorQuote[]
  pricingPacks    PricingPack[]
  pricingPackRows PricingPackRow[]
  proposalSections ProposalSection[]
  outcomes        Outcome[]
  complianceClauses ComplianceClause[]
  clarifications  Clarification[]
  importIssues    ImportIssue[]
  checklist      OpportunityChecklist?
  changeRequests ChangeRequest[]
  notifications Notification[]
}

model OpportunityBidOwner {
  id            String   @id @default(uuid())
  opportunityId String
  userId        String
  createdAt     DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, userId])
  @@index([userId])
}

model BoQItem {
  id            String   @id @default(uuid())
  opportunityId String
  lineNo        Int
  category      String?
  description   String
  qty           Float    @default(1)
  unit          String?
  oem           String?
  sku           String?
  unitCost      Float    @default(0)
  unitCurrency  String   @default("QAR")
  markup        Float    @default(0) // e.g., 0.15 for 15%
  unitPrice     Float    @default(0)
  customFields  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model VendorQuote {
  id            String   @id @default(uuid())
  opportunityId String
  vendor        String
  quoteNo       String?
  validity      DateTime?
  leadTimeDays  Int?
  currency      String?
  files         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model PricingPack {
  id            String   @id @default(uuid())
  opportunityId String
  version       Int      @default(1)
  baseCost      Float    @default(0)
  overheads     Float    @default(0) // fraction, e.g., 0.1
  contingency   Float    @default(0) // fraction
  fxRate        Float    @default(1)
  margin        Float    @default(0.15)
  totalPrice    Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  approvals   Approval[]
  @@index([opportunityId])
}

model PricingPackRow {
  id            String   @id @default(uuid())
  opportunityId String
  lineNo        Int
  description   String
  qty           Float    @default(1)
  unit          String?
  unitCost      Float    @default(0)
  unitCurrency  String   @default("QAR")
  customFields  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model PricingTemplate {
  id            String   @id @default(uuid())
  name          String
  workspace     PricingWorkspace
  scope         PricingTemplateScope @default(GLOBAL)
  columns       Json
  tenantId      String   @default("default")
  opportunityId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity   Opportunity? @relation("TemplateOwner", fields: [opportunityId], references: [id])
  boqOpportunities  Opportunity[] @relation("BoqTemplate")
  packOpportunities Opportunity[] @relation("PackTemplate")
  @@index([tenantId])
}

model FxRate {
  id        String   @id @default(uuid())
  currency  String
  rateToQar Float
  tenantId  String   @default("default")
  updatedAt DateTime @updatedAt

  @@unique([currency, tenantId])
  @@index([tenantId])
}

model ProposalSection {
  id            String   @id @default(uuid())
  opportunityId String
  sectionNo     String?
  title         String
  content       String
  sourcePrompt  String?
  sourceAttachments String[]
  provider      String?
  model         String?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model ImportIssue {
  id            String   @id @default(uuid())
  opportunityId String
  fieldName     String
  columnName    String?
  rowIndex      Int
  rawValue      String?
  message       String
  resolvedAt    DateTime?
  createdAt     DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
  @@index([fieldName])
}

model BusinessRole {
  id          String   @id @default(uuid())
  name        String
  description String?
  tenantId    String   @default("default")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserBusinessRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model UserBusinessRole {
  id             String   @id @default(uuid())
  userId         String
  businessRoleId String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessRole BusinessRole @relation(fields: [businessRoleId], references: [id], onDelete: Cascade)

  @@unique([userId, businessRoleId])
  @@index([businessRoleId])
}

enum ApprovalType {
  LEGAL
  FINANCE
  EXECUTIVE
}

enum ApprovalStatus {
  PENDING
  IN_REVIEW
  APPROVED
  APPROVED_WITH_CONDITIONS
  CHANGES_REQUESTED
  RESUBMITTED
  REJECTED
}

enum TenderScope {
  ITSQ
  IOT_SHABAKA
  OTHER
}

enum TenderClassificationRunType {
  COLLECTOR
  REPROCESS
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

enum NotificationDigestMode {
  INSTANT
  DAILY
  WEEKLY
  OFF
}

enum ChangeRequestStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

model Approval {
  id         String         @id @default(uuid())
  packId     String
  stage      ApprovalStage @default(GO_NO_GO)
  type       ApprovalType
  approverRole String?
  approverIds String[] @default([])
  approverId String?
  status     ApprovalStatus @default(PENDING)
  comment    String?
  attachments Json?
  requestedAt DateTime?
  decidedAt   DateTime?
  reworkCount Int @default(0)
  lateDecision Boolean @default(false)
  signedOn   DateTime?
  signature  String?
  remarks    String?
  changesRequestedDueDate DateTime?
  sourceTenderId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pack PricingPack @relation(fields: [packId], references: [id])
  @@index([packId])
}

model OpportunityChecklist {
  id                           String   @id @default(uuid())
  opportunityId                String   @unique
  bondPurchased                Boolean  @default(false)
  bondPurchasedAt              DateTime?
  bondPurchasedById            String?
  bondPurchaseAttachmentId     String?
  formsCompleted               Boolean  @default(false)
  formsCompletedAt             DateTime?
  formsCompletedById           String?
  formsAttachmentId            String?
  finalPdfReady                Boolean  @default(false)
  finalPdfReadyAt              DateTime?
  finalPdfReadyById            String?
  finalPdfAttachmentId         String?
  portalCredentialsVerified    Boolean  @default(false)
  portalCredentialsVerifiedAt  DateTime?
  portalCredentialsVerifiedById String?
  portalCredentialsAttachmentId String?
  complianceCreated            Boolean  @default(false)
  complianceCreatedAt          DateTime?
  complianceCreatedById        String?
  complianceCreatedAttachmentId String?
  clarificationsSent           Boolean  @default(false)
  clarificationsSentAt         DateTime?
  clarificationsSentById       String?
  clarificationsSentAttachmentId String?
  pricingApproved              Boolean  @default(false)
  pricingApprovedAt            DateTime?
  pricingApprovedById          String?
  notes                        Json?
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model ChangeRequest {
  id            String   @id @default(uuid())
  opportunityId String
  changes       String
  impact        String?
  status        ChangeRequestStatus   @default(PENDING)
  requestedById String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
  @@index([status])
}

model NotificationPreference {
  id         String   @id @default(uuid())
  userId     String
  activity   String
  channel    NotificationChannel
  enabled    Boolean  @default(true)
  digestMode NotificationDigestMode @default(INSTANT)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, activity, channel])
  @@index([userId])
}

model NotificationRoutingDefault {
  id               String   @id @default(uuid())
  tenantId         String   @default("default")
  activity         String
  stage            String?
  userIds          String[]
  businessRoleIds  String[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([tenantId, activity, stage])
  @@index([tenantId])
}

enum ApprovalStage {
  GO_NO_GO
  WORKING
  PRICING
  FINAL_SUBMISSION
  CLARIFICATIONS
}

enum OutcomeStatus {
  WON
  LOST
  WITHDRAWN
  CANCELLED
}

model Outcome {
  id            String        @id @default(uuid())
  opportunityId String
  status        OutcomeStatus
  date          DateTime
  winner        String?
  awardValue    Float?
  notes         String?
  reasonCodes   String[]
  createdAt     DateTime @default(now())

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model AwardStaging {
  id            String   @id @default(uuid())
  portal        String
  tenderRef     String?
  client        String?
  title         String?
  titleOriginal String?
  closeDate     DateTime?
  awardDate     DateTime?
  winners       String[]
  awardValue    Float?
  codes         String[]
  notes         String?
  rawPath       String?
  sourceUrl     String?
  status        String?   // new/parsed/curated
  createdAt     DateTime @default(now())
}

model AwardEvent {
  id         String   @id @default(uuid())
  portal     String
  tenderRef  String?
  client     String?
  title      String?
  titleOriginal String?
  awardDate  DateTime?
  winners    String[]
  awardValue Float?
  codes      String[]
  sourceUrl  String?
  createdAt  DateTime @default(now())
}

model MinistryTender {
  id                  String   @id @default(uuid())
  portal              String
  tenderRef           String?
  title               String?
  titleOriginal       String?
  embedding           Unsupported("vector")?
  ministry            String?
  publishDate         DateTime?
  closeDate           DateTime?
  requestedSectorType String?
  tenderBondValue     Float?
  documentsValue      Float?
  tenderType          String?
  purchaseUrl         String?
  sourceUrl           String?
  status              String?
  tenantId            String   @default("default")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  classification      TenderClassification?

  @@index([portal])
  @@index([tenderRef])
  @@unique([portal, tenderRef])
  @@unique([portal, sourceUrl])
}

model TenderActivity {
  id              String   @id @default(uuid())
  name            String
  description     String?
  scope           TenderScope
  keywords        String[] @default([])
  negativeKeywords String[] @default([])
  embedding       Unsupported("vector")?
  weight          Float?
  isHighPriority  Boolean @default(false)
  isActive        Boolean @default(true)
  tenantId        String  @default("default")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@unique([tenantId, name])
}

model TenderClassification {
  id                   String   @id @default(uuid())
  tenderId             String   @unique
  classificationVersion Int     @default(1)
  score                Int
  scoreItsq            Int     @default(0)
  scoreIotShabaka      Int     @default(0)
  scoreOther           Int     @default(0)
  isNew                Boolean @default(false)
  matchedActivityIds   String[] @default([])
  matchedScopes        TenderScope[] @default([])
  matchedKeywords      String[] @default([])
  reasons              String[] @default([])
  tenantId             String  @default("default")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tender MinistryTender @relation(fields: [tenderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model TenderClassificationRun {
  id                   String   @id @default(uuid())
  runType              TenderClassificationRunType
  classificationVersion Int
  rangeFrom            DateTime?
  rangeTo              DateTime?
  startedAt            DateTime @default(now())
  finishedAt           DateTime?
  stats                Json?
  triggeredBy          String?
  tenantId             String  @default("default")

  @@index([tenantId])
}

model Attachment {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  filename    String
  size        Int
  version     Int       @default(1)
  hash        String
  storagePath String
  tenantId    String    @default("default")
  createdAt   DateTime  @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  action    String
  entity    String
  before    Json?
  after     Json?
  ip        String?
  timestamp DateTime @default(now())
}

model ComplianceClause {
  id             String   @id @default(uuid())
  opportunityId  String
  section        String?
  clauseNo       String?
  requirementText String
  mandatoryFlag  Boolean  @default(false)
  response       String?
  status         String?  // compliant/partial/non-compliant/tbd
  evidence       String?
  owner          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model Clarification {
  id            String   @id @default(uuid())
  opportunityId String
  questionNo    String
  text          String
  status        String?    // open/submitted/answered/closed
  submittedOn   DateTime?
  responseOn    DateTime?
  responseText  String?
  file          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  @@index([opportunityId])
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Notification {
  id         String   @id @default(uuid())
  type       String   // email or event type
  channel    NotificationChannel @default(EMAIL)
  activity   String?
  to         String?
  userId     String?
  subject    String?
  body       String?
  payload    Json?
  status     String   @default("pending") // pending|sent|failed
  attempts   Int      @default(0)
  lastError  String?
  createdAt  DateTime @default(now())
  sentAt     DateTime?
  readAt     DateTime?
  opportunityId String?
  actorId    String?
  tenantId   String   @default("default")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
}
